---
- name: Install and Run Github Self-hosted Runner
  hosts: all
  tasks:
  - name: install pip
    ansible.builtin.include_role:
      name: geerlingguy.pip
      apply:
        become: true
    vars:
      pip_install_packages:
        - name: docker

  - name: install docker and docker-compose
    ansible.builtin.include_role:
      name: geerlingguy.docker
      apply:
        become: true
    vars:
      docker_install_compose_plugin: true
      docker_compose_url: "https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-linux-{{ docker_compose_arch }}"
      docker_apt_filename: "docker"

  - name: set service configuration directory
    become: true
    ansible.builtin.file:
      path: /etc/runner
      state: directory

  - name: copy github-runner docker-compose file
    become: true
    ansible.builtin.template:
      src: docker-compose.yml.j2
      dest: /etc/runner/docker-compose.yml

  - name: poll a image
    become: true
    community.docker.docker_image:
      name: "docker.io/myoung34/github-runner:{{ tag }}"
      source: pull

  - name: start the github-runner container
    become: true
    community.docker.docker_compose_v2:
      project_src: /etc/runner
      state: present 

  - name: change default tcp congestion control to cubic
    become: true
    ansible.posix.sysctl:
      name: net.ipv4.tcp_congestion_control
      value: "cubic"
      sysctl_set: true

  - name: Tune TCP write buffer
    become: true
    ansible.posix.sysctl:
      name: net.ipv4.tcp_wmem
      value: '8192 1048576 33554432'
      sysctl_set: true

  - name: Tune TCP read buffer
    become: true
    ansible.posix.sysctl:
      name: net.ipv4.tcp_rmem
      value: '8192 1048576 33554432'
      sysctl_set: true

  - name: Tune TCP buffer
    become: true
    ansible.posix.sysctl:
      name: net.ipv4.tcp_mem
      value: '268435456 268435456 268435456'
      sysctl_set: true
  
  - name: Tune net core write buffer
    become: true
    ansible.posix.sysctl:
      name: net.core.rmem_max
      value: "268435456"
      sysctl_set: true
  
  - name: Tune net core read buffer
    become: true
    ansible.posix.sysctl:
      name: net.core.wmem_max
      value: "268435456"
      sysctl_set: true
 
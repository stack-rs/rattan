<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rattan Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="Rattan is a high-performance modular transport channel emulator ready for modern WAN.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rattan Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/stack-rs/rattan/tree/main/guide" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<div align="center">
  <h1>
    <a href="https://github.com/stack-rs/rattan"><img alt="Rattan" src="assets/rattan-logo-slim.svg" width="600px" style="border: none; display: block;"></a>
  </h1>
  <a href="https://github.com/stack-rs/rattan/releases"><img alt="GitHub Release" src="https://img.shields.io/github/release/stack-rs/rattan.svg"></a>
  <a href="https://crates.io/crates/rattan"><img alt="crates.io" src="https://img.shields.io/crates/v/rattan.svg"></a>
  <a href="https://github.com/stack-rs/rattan/actions/workflows/build.yml"><img alt="CI" src="https://github.com/stack-rs/rattan/actions/workflows/build.yml/badge.svg"></a>
</div>
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><strong>Rattan</strong> is an extensible and scalable Internet path emulator framework.</p>
<p>We provide a simple and easy-to-use API to create and manage network emulations. Rattan is designed to be used in a wide range of scenarios, from testing network applications to debugging complex network performance issues.</p>
<p>Our modular design makes it easy to extend <strong>Rattan</strong> with different network effects or conditions. We provide a set of built-in modules that can be used to emulate different network conditions, such as bandwidth, latency, packet loss, ISP policies and etc.</p>
<p>We support Linux only at the moment. Currently, kernel version v5.4, v5.15, v6.8 and v6.12 are tested.</p>
<h2 id="design-targets"><a class="header" href="#design-targets">Design Targets</a></h2>
<ul>
<li><strong>High Performance</strong>. Rattan provides both high peak performance and execution efficiency.</li>
<li><strong>Flexible</strong>. Rattan tries to be agnostic of the underlying path emulation model.</li>
<li><strong>Extensible</strong>. Rattan provides rich features out-of-the-box, meanwhile tends to be easily extensible for custom conditions.</li>
<li><strong>User-Friendly</strong>. Rattan aims to provide a simple and intuitive interface for quick usage on common cases and ensure complete controllability under the hood to cover the corner as well.</li>
</ul>
<h2 id="basic-concepts"><a class="header" href="#basic-concepts">Basic Concepts</a></h2>
<p>Run <code>rattan</code> will generate some network namespaces and veth pairs to
emulate the network environment. The network topology is like:</p>
<pre><code class="language-txt">   ns-left                                                           ns-right
+-----------+ [Internet]                               [Internet] +-----------+
|    vL0    |    |                 ns-rattan                 |    |    vR0    |
|  external | &lt;--+          +---------------------+          +--&gt; |  external |
|   vL1-L   |               |  vL1-R  [P]   vR1-L |               |   vR1-R   |
| .1.1.x/32 | &lt;-----------&gt; |.1.1.2/32   .2.1.2/32| &lt;-----------&gt; | .2.1.x/32 |
|   vL2-L   |               |  vL2-R        vR2-L |               |   vR2-R   |
| .1.2.y/32 | &lt;-----------&gt; |.1.2.2/32   .2.2.2/32| &lt;-----------&gt; | .2.2.y/32 |
~    ...    ~   Veth pairs  ~  ...           ...  ~   Veth pairs  ~    ...    ~
+-----------+               +---------------------+               +-----------+
</code></pre>
<p>Then Rattan will build and link the cells according to the configuration file.
Each cell emulates some network characteristics, such as bandwidth, delay, loss, etc.</p>
<p><strong>ATTENTION</strong>: Check firewall settings before running Rattan CLI.
Please make sure you allow the following addresses:</p>
<ul>
<li>10.1.1.0/24</li>
<li>10.2.1.0/24</li>
</ul>
<p>For example, you can run the following commands if using <code>ufw</code>:</p>
<ul>
<li><code>ufw allow from 10.1.1.0/24</code></li>
<li><code>ufw allow from 10.2.1.0/24</code></li>
</ul>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>Rattan is free and open source. You can find the source code on
<a href="https://github.com/stack-rs/rattan">GitHub</a> and issues and feature requests can be posted on
the <a href="https://github.com/stack-rs/rattan/issues">GitHub issue tracker</a>. Rattan relies on the community to fix bugs and
add features: if you'd like to contribute, please read
the <a href="https://github.com/stack-rs/rattan/blob/master/CONTRIBUTING.md">CONTRIBUTING</a> guide and consider opening
a <a href="https://github.com/stack-rs/rattan/pulls">pull request</a>.</p>
<h2 id="citation"><a class="header" href="#citation">Citation</a></h2>
<p>If you want to cite our paper, please use the doi: <a href="https://arxiv.org/abs/2507.08134">2507.08134</a> or the BibTeX entry below:</p>
<pre><code class="language-bibtex">@misc{wang2025rattanextensiblescalablemodular,
      title={Rattan: An Extensible and Scalable Modular Internet Path Emulator},
      author={Minhu Wang and Yixin Shen and Bo Wang and Haixuan Tong and Yutong Xie and Yixuan Gao and Yan Liu and Li Chen and Mingwei Xu and Jianping Wu},
      year={2025},
      eprint={2507.08134},
      archivePrefix={arXiv},
      primaryClass={cs.NI},
      url={https://arxiv.org/abs/2507.08134},
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>The Rattan project contains a CLI tools (named <code>rattan</code>) for common use cases and
a Rust library (named <code>rattan-core</code>) for you to build your own tools on top of.</p>
<p>There are multiple ways to install the Rattan CLI tool.
Choose any one of the methods below that best suit your needs.</p>
<div class="mdbook-alerts mdbook-alerts-caution">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  caution
</p>
<p>As we are still in the early stages of development without a released version, we only support building from source currently.</p>
</div>
<h2 id="pre-compiled-binaries"><a class="header" href="#pre-compiled-binaries">Pre-compiled binaries</a></h2>
<p>Executable binaries are available for download on the <a href="https://github.com/stack-rs/rattan/releases">GitHub Releases page</a>.
Download the binary and extract the archive.
The archive contains an <code>rattan</code> executable which you can run to start your distributed platform.</p>
<p>To make it easier to run, put the path to the binary into your <code>PATH</code> or install it in a directory that is already in your <code>PATH</code>.
Note that, you have to grant the binary the necessary capabilities to run.
For example, you can run the following commands on Linux:</p>
<pre><code class="language-bash"># install the binary
sudo install -m 755 rattan /usr/local/bin/rattan
# grant the necessary capabilities
sudo setcap 'cap_dac_override,cap_dac_read_search,cap_sys_ptrace,cap_net_admin,cap_sys_admin,cap_net_raw+ep' /usr/local/bin/rattan
</code></pre>
<p>Besides, for certain operating systems that enable <code>systemd-networkd</code>, you have to configure it to not change MAC address of veth interfaces.
You can do this by adding the following lines to <code>/lib/systemd/network/80-rattan.link</code>:</p>
<pre><code class="language-ini">[Match]
OriginalName=ns*-v*-*
Driver=veth

[Link]
MACAddressPolicy=none
</code></pre>
<p>And then restart the <code>systemd-networkd</code> service:</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl restart systemd-networkd.service
</code></pre>
<p>We also contain a install script <a href="https://github.com/stack-rs/rattan/blob/main/scripts/install.sh">scripts/install.sh</a> in the repository, which you can use to install the binary on Ubuntu:</p>
<pre><code class="language-bash">./scripts/install.sh rattan
</code></pre>
<h2 id="build-from-source-using-rust"><a class="header" href="#build-from-source-using-rust">Build from source using Rust</a></h2>
<h3 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h3>
<p>We recommend developers to install the following dependencies for better testing and development experience. And you have to install some of the dependencies to build rattan with specific features:</p>
<pre><code class="language-bash">sudo apt install ethtool iputils-ping iperf3 pkg-config m4 clang llvm libelf-dev libpcap-dev gcc-multilib libnftnl-dev libmnl-dev
</code></pre>
<h3 id="installing-with-cargo"><a class="header" href="#installing-with-cargo">Installing with Cargo</a></h3>
<p>To build the <code>rattan</code> executable from source, you will first need to install Rust and Cargo.
Follow the instructions on the <a href="https://www.rust-lang.org/tools/install">Rust installation page</a>.</p>
<p>Once you have installed Rust, the following command can be used to build and install rattan:</p>
<pre><code class="language-bash">cargo install rattan
</code></pre>
<p>This will automatically download rattan from <a href="https://crates.io/">crates.io</a>, build it, and install it in Cargo's global binary directory (<code>~/.cargo/bin/</code> by default).</p>
<p>You can run <code>cargo install rattan</code> again whenever you want to update to a new version.
That command will check if there is a newer version, and re-install rattan if a newer version is found.</p>
<p>To uninstall, run the command <code>cargo uninstall rattan</code>.</p>
<h3 id="installing-the-latest-git-version-with-cargo"><a class="header" href="#installing-the-latest-git-version-with-cargo">Installing the latest git version with Cargo</a></h3>
<p>The version published to crates.io will ever so slightly be behind the version hosted on GitHub.
If you need the latest version you can build the git version of rattan yourself.
Cargo makes this <strong><em>super easy</em></strong>!</p>
<pre><code class="language-bash">cargo install --git https://github.com/stack-rs/rattan.git rattan
</code></pre>
<p>Again, make sure to add the Cargo bin directory to your <code>PATH</code>.</p>
<h3 id="building-from-source"><a class="header" href="#building-from-source">Building from source</a></h3>
<p>If you want to build the binary from source, you can clone the repository and build it using Cargo.</p>
<pre><code class="language-bash">git clone https://github.com/stack-rs/rattan.git
cd rattan
cargo build --release
</code></pre>
<p>Then you can find the binary in <code>target/release/rattan</code> and install or run it as you like (e.g., run <code>./scripts/install.sh target/release/rattan</code>).</p>
<h2 id="modifying-and-contributing"><a class="header" href="#modifying-and-contributing">Modifying and contributing</a></h2>
<p>If you are interested in making modifications to Rattan itself, check out the <a href="https://github.com/stack-rs/mitosis/blob/master/CONTRIBUTING.md">Contributing Guide</a> for more information.</p>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="bundled-cli-tool"><a class="header" href="#bundled-cli-tool">Bundled CLI Tool</a></h1>
<p>The Rattan project provides a CLI tool named <code>rattan</code> for common use cases.
The tool is built on top of the <code>rattan-core</code> library, which you can use to build your own tools.</p>
<p>We provide different features under different subcommands:</p>
<ul>
<li><a href="guide/predefined-channels.html">rattan link</a>:
Run a templated channel with command line arguments.
We include a set of predefined cells and templated channels in the tool to help you get started quickly.
You can emulate a simple network path with just a few commands.</li>
<li><a href="guide/flexible-configuration.html">rattan run</a>:
Run the instance according to the configuration.
For more complex configurations or reproduction purpose, you can use the flexible configuration file to define your own channel with specific cells, network paths and even routes.</li>
</ul>
<p>There are also global options that you can use to customize the behavior of the tool:</p>
<ul>
<li><code>--generate</code> and <code>--generate-path</code> are used to generate a configuration file from your settings instead of running an instance.</li>
<li><code>--packet-log</code> is used to enable compressed packet log and specify the file to store the records. See <a href="guide/../ref/packet-log.html">Packet Log</a> for more details.</li>
<li><code>--file-log</code> and <code>--file-log-path</code> are used to enable logging to a file and specify the path to store the log.</li>
</ul>
<p>For more detailed usage, you can run <code>rattan --help</code> to see the available commands and options:</p>
<pre><code class="language-txt">Usage: rattan [OPTIONS] &lt;COMMAND&gt;

Commands:
  link  Run a templated channel with command line arguments
  run   Run the instance according to the config
  help  Print this message or the help of the given subcommand(s)

Options:
      --generate              Generate config file instead of running a instance
      --generate-path &lt;File&gt;  Generate config file to the specified path instead of stdout
      --packet-log &lt;File&gt;     The file to store compressed packet log (overwrite config) (default: None)
      --file-log              Enable logging to file
      --file-log-path &lt;File&gt;  File log path, default to $CACHE_DIR/rattan/core.log
  -h, --help                  Print help (see more with '--help')
  -V, --version               Print version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="predefined-cells-and-templated-channels"><a class="header" href="#predefined-cells-and-templated-channels">Predefined Cells and Templated Channels</a></h1>
<p>The templated channels consist of a set of cells defined in the <code>rattan-core</code> library, which you can use to quickly set up a network path for testing.
You can use these channels through the <code>rattan link</code> subcommand with just a few command line arguments.</p>
<p>For now, we only provide a simple bidirectional channel, with each direction comprising three cells: <code>bandwidth</code>, <code>delay</code> and <code>loss</code>.
This channel is suitable for most common network emulation scenarios.</p>
<p>You can configure the parameters of each cell by passing the arguments to the subcommand.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>For example, to create a channel with 10Mbps bandwidth, infinite queue, 50ms latency and 1% loss rate in both directions, you can run the following command:</p>
<pre><code class="language-bash">rattan link --uplink-bandwidth 10Mbps --uplink-delay 50ms --uplink-loss 0.1 \
--downlink-bandwidth 10Mbps --downlink-delay 50ms --downlink-loss 0.1
</code></pre>
<p>Then you will be prompted to a shell with the network path set up.</p>
<h3 id="an-illustration-example-of-testing"><a class="header" href="#an-illustration-example-of-testing">An Illustration Example of Testing</a></h3>
<p>We are going to illustrate a simple example of testing network performance using <code>rattan link</code> and <code>iperf3</code>.
Before testing, don't remember to disable your firewall to allow <code>iperf3</code> traffic, or allow from <code>10.0.0.0/8</code>,
as Rattan is using that as the default IP addresses for the emulated network.</p>
<p>As the <code>rattan link</code> subcommand runs in the <code>Compatible Mode</code> (which is similar to <a href="https://github.com/ravinet/mahimahi">mahimahi</a>),
we should fist launch an <code>iperf3</code> server in one terminal on the host (outside of rattan):</p>
<pre><code class="language-bash">iperf3 -s -1
</code></pre>
<p>After that, we can launch the <code>rattan link</code> command in another terminal to set up the network path:</p>
<pre><code class="language-bash">rattan link --uplink-bandwidth 12Mbps --uplink-delay 50ms --downlink-bandwidth 12Mbps --downlink-delay 50ms
</code></pre>
<p>In this way, we create a link with 12Mbps bandwidth, 100ms RTT and no loss.</p>
<p>Now it will prompt you to a shell. If you are using bash or specify the shell to use when invoking rattan with <code>rattan link -s bash</code>,
you will get the following prompt in your terminal indicating that you are now in the rattan environment:</p>
<pre><code class="language-bash">[rattan] user@hostname:
</code></pre>
<p>Similar to mahimahi, we have an environment variable <code>RATTAN_BASE</code> containing the IP address of the other end of the link.</p>
<p>So in the shell, we can just run the following iperf3 client command to test the network performance:</p>
<pre><code class="language-bash">iperf3 -c $RATTAN_BASE -t 10
</code></pre>
<h3 id="available-options"><a class="header" href="#available-options">Available Options</a></h3>
<p>For detailed usage, you can run <code>rattan link --help</code> to see the available cells and options:</p>
<pre><code class="language-txt">Run a templated channel with command line arguments

Usage: rattan link [OPTIONS] [-- &lt;COMMAND&gt;...]

Arguments:
  [COMMAND]...
          Command to run. Only used when in compatible mode

Options:
      --uplink-loss &lt;Loss&gt;
          Uplink packet loss

      --downlink-loss &lt;Loss&gt;
          Downlink packet loss

      --generate
          Generate config file instead of running a instance

          If this flag is set, the program will only generate the config to stdout and exit.

      --uplink-delay &lt;Delay&gt;
          Uplink delay

      --downlink-delay &lt;Delay&gt;
          Downlink delay

      --left-stdout
          Used in isolated mode only. If set, stdout of left is passed to output of this program

      --right-stdout
          Used in isolated mode only. If set, stdout of rihgt is passed to output of this program

      --uplink-bandwidth &lt;Bandwidth&gt;
          Uplink bandwidth

      --left-stderr
          Used in isolated mode only. If set, stderr of left is passed to output of this program

      --uplink-trace &lt;File&gt;
          Uplink trace file

      --right-stderr
          Used in isolated mode only. If set, stderr of right is passed to output of this program

      --uplink-queue &lt;Queue Type&gt;
          Uplink queue type

          [possible values: infinite, droptail, drophead, codel]

      --generate-path &lt;File&gt;
          Generate config file to the specified path instead of stdout

      --uplink-queue-args &lt;JSON&gt;
          Uplink queue arguments

      --downlink-bandwidth &lt;Bandwidth&gt;
          Downlink bandwidth

      --packet-log &lt;File&gt;
          The file to store compressed packet log (overwrite config) (default: None)

      --downlink-trace &lt;File&gt;
          Downlink trace file

      --file-log
          Enable logging to file

      --downlink-queue &lt;Queue Type&gt;
          Downlink queue type

          [possible values: infinite, droptail, drophead, codel]

      --file-log-path &lt;File&gt;
          File log path, default to $CACHE_DIR/rattan/core.log

      --downlink-queue-args &lt;JSON&gt;
          Downlink queue arguments

      --no-nat
          Disable NAT in compatible mode

  -s, --shell &lt;SHELL&gt;
          Shell used to run if no command is specified. Only used when in compatible mode

          [default: default]
          [possible values: default, sh, bash, zsh, fish]

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="flexible-configuration"><a class="header" href="#flexible-configuration">Flexible Configuration</a></h1>
<p>Generally, our specialized network emulations necessitate a different number of cells or more complex channels, and they may even require the configuration of routes, such as a multi-path network path with ISP QoS policies. Our CLI tool achieves flexibility and configurability through the use of TOML config files. The configuration file primarily consists of six sections.</p>
<p>We provide an example config file <a href="https://github.com/stack-rs/rattan/blob/main/config.example.toml">config.example.toml</a> as reference. You can just copy and modify it to suit your needs.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>It is very straightforward to use a config file to run a rattan instance. You can run the following command:</p>
<pre><code class="language-bash">rattan run -c config.example.toml --left=echo --left=hello
</code></pre>
<p>This will just print "hello" in the terminal as the <code>config.example.toml</code> is in <code>Compatible Mode</code>.</p>
<p>For large scale tests, we recommend you to use the <code>Isolated Mode</code>. Both sides of Rattan (typically one running client and one running server) are isolated to a independent network namespace.</p>
<h3 id="an-illustration-example-of-testing-1"><a class="header" href="#an-illustration-example-of-testing-1">An Illustration Example of Testing</a></h3>
<p>We are going to illustrate a simple example of testing network performance using <code>rattan link</code> and <code>iperf3</code> in <code>Isolated Mode</code> with a config file defined.
Before testing, don't remember to disable your firewall to allow <code>iperf3</code> traffic, or allow from <code>10.0.0.0/8</code>,
as Rattan is using that as the default IP addresses for the emulated network.</p>
<p>We should first define two scripts to use in the config file:</p>
<p>We could create a script <code>iperf3_server.sh</code> as follows:</p>
<pre><code class="language-bash">#!/bin/bash
iperf3 -s -1 -J --logfile iperf3_server.log
</code></pre>
<p>And a script <code>iperf3_client.sh</code> as follows:</p>
<pre><code class="language-bash">#!/bin/bash
sleep 1 # we sleep 1 second to wait for server to be ready
iperf3 -c $RATTAN_BASE -t 10 -J --logfile iperf3_client.log
</code></pre>
<p>We output the client and server results to json log files, as we are running in <code>Isolated Mode</code> and cannot see the terminal output directly.</p>
<p>After that, we can create a config file <code>iperf3_config.toml</code> as follows:</p>
<pre><code class="language-toml">[env]
mode = "Isolated"
left_veth_count = 1
right_veth_count = 1

[links]
left = "up_loss"
up_loss = "up_bandwidth"
up_bandwidth = "up_delay"
up_delay = "right"
right = "down_loss"
down_loss = "down_bandwidth"
down_bandwidth = "down_delay"
down_delay = "left"

[cells.up_delay]
type = "Delay"
delay = "50ms"

[cells.up_bandwidth]
type = "Bw"
queue = "Infinite"
bandwidth = "12Mbps"

[cells.up_loss]
type = "Loss"
pattern = []

[cells.down_delay]
type = "Delay"
delay = "50ms"

[cells.down_bandwidth]
type = "Bw"
queue = "DropTail"
bandwidth = "12Mbps"
[cells.down_bandwidth.queue_config]
byte_limit = 125000

[cells.down_loss]
type = "Loss"
pattern = [ 0.0,]

[commands]
left = ["bash", "iperf3_client.sh"]
right = ["bash", "iperf3_server.sh"]
</code></pre>
<p>This creates 12Mbps bandwidth, 100ms RTT and no loss link between the two network namespaces.
The only difference of it with the <a href="guide/predefined-channels.html#an-illustration-example-of-testing">example of rattan link</a> is that now we define a <code>DropTail</code> queue in the downlink.</p>
<p>The <code>commands</code> section specifies the commands to run in the two network namespaces, in this case, the <code>iperf3</code> client and server scripts we defined before.</p>
<p>Now we can run the rattan instance with the config file:</p>
<pre><code class="language-bash">rattan run -c iperf3_config.toml
</code></pre>
<p>Wait for it to finish, and then we can check the <code>iperf3_client.log</code> and <code>iperf3_server.log</code> files for the results.</p>
<p>If you want to see the terminal output of both sides, you should first remove the <code>-J --logfile xxx.log</code> part from both client and server side iperf3 scripts.
Then you can add the <code>--left-stdout</code> and <code>--right-stdout</code> options to <code>rattan run</code> command like this:</p>
<pre><code class="language-bash">rattan run -c iperf3_config.toml --left-stdout --right-stdout
</code></pre>
<h3 id="available-options-1"><a class="header" href="#available-options-1">Available Options</a></h3>
<p>For detailed usage, you can run <code>rattan config --help</code> to see the available cells and options:</p>
<pre><code class="language-txt">Run the instance according to the config

Usage: rattan run [OPTIONS] --config &lt;Config File&gt;

Options:
  -c, --config &lt;Config File&gt;
          Use config file to run a instance

      --left [&lt;LEFT_COMMAND&gt;...]
          Command to run in left ns. Can be used in compatible and isolated mode

      --generate
          Generate config file instead of running a instance

          If this flag is set, the program will only generate the config to stdout and exit.

      --right [&lt;RIGHT_COMMAND&gt;...]
          Command to run in right ns. Only used in isolated mode

      --left-stdout
          Used in isolated mode only. If set, stdout of left is passed to output of this program

      --right-stdout
          Used in isolated mode only. If set, stdout of rihgt is passed to output of this program

      --left-stderr
          Used in isolated mode only. If set, stderr of left is passed to output of this program

      --right-stderr
          Used in isolated mode only. If set, stderr of right is passed to output of this program

      --generate-path &lt;File&gt;
          Generate config file to the specified path instead of stdout

      --packet-log &lt;File&gt;
          The file to store compressed packet log (overwrite config) (default: None)

      --file-log
          Enable logging to file

      --file-log-path &lt;File&gt;
          File log path, default to $CACHE_DIR/rattan/core.log

      --no-nat
          Disable NAT in compatible mode

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version
</code></pre>
<h2 id="explanation-of-config-sections"><a class="header" href="#explanation-of-config-sections">Explanation of Config Sections</a></h2>
<h3 id="general-section"><a class="header" href="#general-section">General Section</a></h3>
<p>This section determines how to run the rattan itself in general.</p>
<ul>
<li><code>packet_log</code>. Now we only have this option in the section, which is used to enable compressed packet log and specify the file to store the records. The meta data of flows will be stored in the file of name <code>packet_log</code>.flows</li>
</ul>
<h3 id="environment-section"><a class="header" href="#environment-section">Environment Section</a></h3>
<p>This section determines how to build the environment.</p>
<ul>
<li><code>mode</code>. You can configure rattan to function in <code>Compatible</code> mode or <code>Isolated</code> mode. The <code>ns-left</code> side is always a new network namespace. The difference of the two modes lies in whether <code>ns-right</code> side is the host network namespace (the namespace run rattan) or a new network namespace. The default is <code>Compatible</code>.</li>
<li><code>left_veth_count</code> and <code>right_veth_count</code>. You can configure the number of veth pairs to create in the <code>ns-left</code> (i.e., between <code>ns-left</code> and <code>ns-rattan</code>) and <code>ns-right</code> (i.e., between <code>ns-right</code> and <code>ns-rattan</code>) network namespaces. The default is 1.</li>
</ul>
<h3 id="http-section"><a class="header" href="#http-section">HTTP Section</a></h3>
<p>This section configures Rattan's HTTP control server.</p>
<ul>
<li><code>enable</code>. You can enable or disable the HTTP control server. The default is <code>false</code>.</li>
<li><code>port</code>. You can configure the port number of the HTTP control server. The default is 8086.</li>
</ul>
<h3 id="cells-section"><a class="header" href="#cells-section">Cells Section</a></h3>
<p>This section describes the emulation cells. It is a table of cells, where each cell has a unique string ID, defined like <code>[cells.&lt;ID&gt;]</code>.</p>
<p>Each cell <strong>MUST</strong> have a "type" field, which determines the cell type and cell configuration fields.
Possible cell types:</p>
<ul>
<li><code>Bw</code>: Fixed bandwidth</li>
<li><code>BwReplay</code>: Bandwidth trace replayer</li>
<li><code>Delay</code>: Fixed delay</li>
<li><code>DelayReplay</code>: Delay trace replayer</li>
<li><code>DelayPerPacket</code>: Delay specified per-packet</li>
<li><code>Loss</code>: Loss pattern</li>
<li><code>LossReplay</code>: Loss trace replayer</li>
<li><code>Spy</code>: Log all packets</li>
<li><code>Custom</code>: Custom cell, only specify the cell ID used in link section, and the cell must be built by the user</li>
</ul>
<p>For example, the following is a cell configuration for a fixed bandwidth cell:</p>
<pre><code class="language-toml">[cells.up_1]
type = "Bw"
bw_type = "NetworkLayer"
bandwidth = "1Gbps 200Mbps"
queue = "DropTail"
queue_config = { packet_limit = 60 }
</code></pre>
<p>For detailed parameters, you can check the <a href="https://docs.rs/rattan-core/latest/rattan-core">documentation of <code>rattan-core</code></a> or the example config file <a href="https://github.com/stack-rs/rattan/blob/main/config.example.toml">config.example.toml</a>.</p>
<p>To make the result more duplicable, Rattan synchronize the start time of all cell types that are time-dependent, including <code>DelayReplay</code>, <code>BwReplay</code>, and <code>LossReplay</code>, for them to replay traces at the same time base.
The start time is conditionally defined. By default, we use the <code>FIRST_PACKET</code> time as the start time. But users can also choose to use the Rattan start-up time as the start time.</p>
<p>The <code>FIRST_PACKET</code> is defined as the first L2 unicast packet to enter Rattan. An L2 unicast packet has a <strong>destination</strong> MAC address with the 8th bit (the Individual/Group bit) set to <code>0</code>.</p>
<p>For example, <code>38:7e:58:e7:02:01</code> is a unicast MAC address because the 8th bit (the least-significant bit of the first byte, <code>0x38</code>) is <code>0</code>. In contrast, MAC addresses like <code>01:00:5e:00:00:fb</code> or <code>33:33:00:00:02</code> are <strong>not</strong> unicast.</p>
<p><strong>Examples of a <code>FIRST_PACKET</code>:</strong></p>
<ul>
<li>A TCP SYN packet from the client.</li>
<li>An ICMP Echo Request (Ping).</li>
</ul>
<p><strong>Packets that cannot be a <code>FIRST_PACKET</code> (often generated by the Linux network stack):</strong></p>
<ul>
<li>An ICMPv6 Router Solicitation.</li>
<li>An mDNS (Multicast Domain Name System) query.</li>
</ul>
<p>This design ensures that the trace does not begin replaying until actual application traffic has started.</p>
<h3 id="links-section"><a class="header" href="#links-section">Links Section</a></h3>
<p>This section describes how to link the cells.</p>
<p>"left" and "right" are preserved cell IDs, which respectively represent
the <code>ns-left</code> side veth (named <code>vL1-R</code>) and the <code>ns-right</code> side veth (named <code>vR1-L</code>).
But if a network namespace has more than one veth NICs, <code>ns-left</code> side for example, "left1", "left2" etc. will be defined.</p>
<p>The other cell IDs are defined by user in the cells section.</p>
<p>Each line describes a one-way link from a cell egress to a cell ingress.</p>
<p>For example, to emulate a network topology with two network paths like following:</p>
<pre><code class="language-txt">+-------+  --------&gt;  shadow ---&gt;  up_1  ---&gt;  up_2  ---&gt; +-------+
| left1 | &lt;==+           ^                                | right |
+-------+    }= router &lt;-|------- down_2 &lt;--- down_1 &lt;--- +-------+
| left2 | &lt;==+           |
+-------+  --------------+

Note: The double line "&lt;===" from router is connected in Cells Section
</code></pre>
<p>You can configure the link section like this:</p>
<pre><code class="language-toml">[links]
left1 = "shadow"
left2 = "shadow"
shadow = "up_1"
up_1 = "up_2"
up_2 = "right"
right = "down_1"
down_1 = "down_2"
down_2 = "router"
# We do not need to link the Router Cell to other cells anymore, as we should do it in Cells Section
</code></pre>
<h3 id="resource-section"><a class="header" href="#resource-section">Resource Section</a></h3>
<p>This section describes how rattan use system resource</p>
<p>The section is preserved for future use but not used now.</p>
<ul>
<li><code>cores</code>. The CPU cores that rattan is allowed to use.</li>
</ul>
<h3 id="commands-section"><a class="header" href="#commands-section">Commands Section</a></h3>
<p>This section describes the commands to run in rattan.</p>
<p>When in <code>Compatible</code> mode, only the <code>left</code> and <code>shell</code> options are used,
and the commands will run in the <code>ns-left</code> network namespace.</p>
<p>When in <code>Isolated</code> mode, only the left and right options are used,
and the commands will run in the <code>ns-left</code> and <code>ns-right</code> network namespace, respectively.</p>
<ul>
<li><code>left</code> and <code>right</code>. The commands to run in the <code>ns-left</code> and <code>ns-right</code> network namespace, respectively. Should be an array of strings.</li>
<li><code>shell</code>. The shell used to run if no command is specified. Only used when in compatible mode. The default is <code>Default</code> (i.e., the default shell defined in environment variable <code>$SHELL</code>).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="write-a-new-cell"><a class="header" href="#write-a-new-cell">Write a New Cell</a></h1>
<p>In Rattan, a "cell" is a unit that emulates various network effects for your network path, including delay, packet loss, reordering, and so forth.
As the fundamental building block of Rattan, cells follow the actor concurrency programming model. Each cell runs as an self-contained coroutine that processes events through several well-defined asynchronous interfaces (i.e., <code>Ingress</code>, <code>Egress</code>, <code>ControlInterface</code>).</p>
<p>Users can combine different cells to emulate a variety of network scenarios. We've bundled several built-in cells in Rattan to support common network effects, including the <code>Delay</code> cell, <code>Loss</code> cell, among others.</p>
<p>However, there may be instances where users wish to implement additional effects or need to cater to specific requirements within a cell. In such cases, they can follow this guide to create their own custom cell.</p>
<h2 id="basic-structure"><a class="header" href="#basic-structure">Basic Structure</a></h2>
<p>A cell in Rattan is primarily composed of the following components: <a href="guide/new-cell.html#ingress"><code>Ingress</code></a>, <a href="guide/new-cell.html#egress"><code>Egress</code></a>, and <a href="guide/new-cell.html#controlinterface"><code>ControlInterface</code></a>.
To implement your own cell, you need to implement these three traits, along with an additional <a href="guide/new-cell.html#cell"><code>Cell</code></a> trait to combine them together.</p>
<p>In the design of Rattan, each <code>Cell</code> receives packets via <code>Ingress</code> and sends packets via <code>Egress</code>. The <code>Cell</code> settings can be adjusted at runtime through the <code>ControlInterface</code>. The Rattan core handles the forwarding of packets from the <code>Egress</code> of one <code>Cell</code> to the <code>Ingress</code> of another.</p>
<p>In the following sections, we will use a <code>DropPacketCell</code> as an example, which drops one packet every <code>loss_interval</code> packets, to illustrate the basic structure and implementation process of a cell.</p>
<h3 id="ingress"><a class="header" href="#ingress">Ingress</a></h3>
<p>The <code>Ingress</code> is used to receive packets, which are dequeued by other cells and forwarded by the rattan core.
It serves as the entry point for our cell, hence the need for us to implement an <code>enqueue</code> method to pass forwarded packets into the cell.</p>
<p>Typically, we use a channel to forward packets within the cell. As such, we can incorporate an <code>UnboundedSender</code> member within <code>Ingress</code> and use its <code>send</code> method to transmit packets (similarly, we can include an <code>UnboundedReceiver</code> member within <code>Egress</code> and use its <code>recv</code> method to receive packets).</p>
<p>A single <code>Ingress</code> is shared across multiple forwarding threads to allow flexible composition, so it can only have an immutable reference to itself in the <code>enqueue</code> method and must implement the <code>Clone</code> trait. It is worth attention that mutable operations on packets are possible within the method.</p>
<p>Here is an example of an <code>Ingress</code> implementation, which we set the timestamp of the packet to the current time before sending it to the <code>Egress</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct DropPacketCellIngress&lt;P&gt;
where
    P: Packet,
{
    // Send packets to Egress
    ingress: mpsc::UnboundedSender&lt;P&gt;,
}

impl&lt;P&gt; Clone for DropPacketCellIngress&lt;P&gt;
where
    P: Packet,
{
    fn clone(&amp;self) -&gt; Self {
        Self {
            ingress: self.ingress.clone(),
        }
    }
}

impl&lt;P&gt; Ingress&lt;P&gt; for DropPacketCellIngress&lt;P&gt;
where
    P: Packet + Send,
{
    fn enqueue(&amp;self, mut packet: P) -&gt; Result&lt;(), Error&gt; {
        packet.set_timestamp(Instant::now());
        self.ingress
            .send(packet)
            .map_err(|_| Error::ChannelError("Data channel is closed.".to_string()))?;
        Ok(())
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="egress"><a class="header" href="#egress">Egress</a></h3>
<p>The <code>Egress</code> is used to dequeue packets from the <code>Cell</code>, which are then sent to another cell by the rattan core. It serves as the export of the cell.</p>
<p>As we mentioned above, we typically use a channel to forward packets within the cell. Therefore, we can include an <code>UnboundedReceiver</code> member within <code>Egress</code> and use its <code>recv</code> method to receive packets for further process.</p>
<p>The <code>Egress</code> component is designed to be exclusively held by a single thread, allowing its <code>dequeue</code> method to obtain a mutable reference to itself.
This design allows for stateful operations within this method. Network effects often necessitate maintaining mutable internal states.</p>
<p>For instance, the Gilbert-Elliott packet loss model requires internal state transitions along with a varying packet loss probability.</p>
<p>Consequently, we usually implement the majority of packet handling strategies, such as delaying or dropping a packet, and modify the internal states within the <code>dequeue</code> method.</p>
<p>We always include a <code>state</code> variable (typically, an <code>AtomicI32</code>) in the <code>Egress</code> struct to control the cell's state, which is informed by Rattan runtime through method <code>change_state</code>. Currently, three values are supported: 0 (drop), 1 (pass-through), and 2 (normal operation).
Also, we include a configuration receiver (the specific type depends on the way you implement trait <code>ControlInterface</code>) to receive configuration information from the <code>ControlInterface</code>.</p>
<p>An example is shown below:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct DropPacketCellEgress&lt;P&gt;
where
    P: Packet,
{
    // Receive packets from Ingress
    egress: mpsc::UnboundedReceiver&lt;P&gt;,
    // Internal states
    inner_loss_interval: usize,
    counter: usize,
    loss_interval: Arc&lt;AtomicUsize&gt;,
    state: AtomicI32,
}
<span class="boring">}</span></code></pre></pre>
<p>Here, <code>loss_interval</code> is used to receive the configuration information from the <code>ControlInterface</code>, <code>inner_loss_interval</code> is used to store the received parameters, <code>counter</code> is used to count the number of packets since last packet loss, and <code>state</code> is used to control the state of the cell.</p>
<p>For the <code>Egress</code> trait, you must implement the <code>dequeue</code> method and might override the <code>change_state</code> and <code>reset</code> method (both are blank implementations by default).
The <code>dequeue</code> method is where you implement the functional logic of your cell. For example, if you need a delay function, you can write your <code>dequeue</code> method to return a packet after a specified delay time; if you need to drop packets, you can write your <code>dequeue</code> method to return a packet or drop it with a certain probability.
The <code>change_state</code> method is used to control the state of your cell.
The <code>reset</code> method is used to reset the internal state of your cell, often useful in calibrating the internal timer, which will always be called by Rattan runtime before each run.</p>
<p>Here is an example of an <code>Egress</code> implementation, which drops one packet every <code>loss_interval</code> packets:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl&lt;P&gt; Egress&lt;P&gt; for DropPacketCellEgress&lt;P&gt;
where
    P: Packet + Send + Sync,
{
    async fn dequeue(&amp;mut self) -&gt; Option&lt;P&gt; {
        // Receive packets from Ingress
        let packet = match self.egress.recv().await {
            Some(packet) =&gt; packet,
            None =&gt; return None,
        };
        // Check state of your cell
        match self.state.load(std::sync::atomic::Ordering::Acquire) {
            0 =&gt; {
                // Drop
                return None;
            }
            1 =&gt; {
                // Pass-through
                return Some(packet);
            }
            _ =&gt; {}
        }
        // The control logic of your own cell
        self.counter += 1;
        self.inner_loss_interval = self
            .loss_interval
            .load(std::sync::atomic::Ordering::Acquire);
        if self.counter &gt;= self.inner_loss_interval &amp;&amp; self.inner_loss_interval != 0 {
            self.counter = 0;
            None
        } else {
            Some(packet)
        }
    }

    fn change_state(&amp;self, state: i32) {
        self.state
            .store(state, std::sync::atomic::Ordering::Release);
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="controlinterface"><a class="header" href="#controlinterface">ControlInterface</a></h3>
<p>The <code>ControlInterface</code> trait is only required when you need to modify the configuration (or exchange information) of your cell at runtime. It is used to pass configuration information to the <code>Egress</code> component.
Developers are responsible for</p>
<p>Developers are responsible for embedding communication mechanisms at both ends (i.e., <code>ControlInterface</code> and <code>Egress</code>).
This can be achieved using atomic types, channels, or shared memory, depending on the specific requirements of the cell.
There is also a requirement to modify <code>Egress</code> to read or listen for pertinent information.
The only method that this trait requires is the <code>set_config</code> method, which is designed to execute the desired communication mechanism or other logical code.</p>
<p>The example provided in this guide utilizes atomic types and is intended solely for reference purposes:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct DropPacketCellControlInterface {
    loss_interval: Arc&lt;AtomicUsize&gt;,
}

impl ControlInterface for DropPacketCellControlInterface {
    type Config = DropPacketCellConfig;

    fn set_config(&amp;self, config: Self::Config) -&gt; Result&lt;(), Error&gt; {
        self.loss_interval
            .store(config.loss_interval, std::sync::atomic::Ordering::Release);
        Ok(())
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Note that the code above includes a <code>DropPacketCellConfig</code> struct, which is the configuration struct defined for the example cell.
When implementing the <code>ControlInterface</code> trait, we also need to define a struct for our cell's configuration.
This struct typically contains the parameters that you want to use within the cell.
It will also be helpful if you want to read settings or parameters from some configuration files (e.g., TOML).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Default, Clone)]
pub struct DropPacketCellConfig {
    pub loss_interval: usize,
}

impl DropPacketCellConfig {
    pub fn new&lt;T: Into&lt;usize&gt;&gt;(loss_interval: T) -&gt; Self {
        Self {
            loss_interval: loss_interval.into(),
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="cell"><a class="header" href="#cell">Cell</a></h3>
<p>Up until now, we have implemented the three necessary traits for creating a custom cell: <code>Ingress</code>, <code>Egress</code>, and <code>ControlInterface</code>, along with the struct for the cell's configuration information.
However, these structs are just parts of the cell. In order to make them function properly in Rattan, we need to assemble them into a single struct. This is why we need to implement the <code>Cell</code> trait.</p>
<p>The <code>Cell</code> trait has four methods that must be implemented: <code>sender</code>, <code>receiver</code>, <code>into_receiver</code>, and <code>control_interface</code>:</p>
<ul>
<li>The <code>sender</code> method returns a cloned <code>Arc</code> of the <code>Ingress</code></li>
<li>The <code>receiver</code> method returns a mutable reference to the <code>Egress</code></li>
<li>The <code>into_receiver</code> method returns the <code>Egress</code></li>
<li>The <code>control_interface</code> method returns an <code>Arc</code> of the <code>ControlInterface</code></li>
</ul>
<p>Refer to the example below:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct DropPacketCell&lt;P: Packet&gt; {
    ingress: Arc&lt;DropPacketCellIngress&lt;P&gt;&gt;,
    egress: DropPacketCellEgress&lt;P&gt;,
    control_interface: Arc&lt;DropPacketCellControlInterface&gt;,
}

impl&lt;P&gt; Cell&lt;P&gt; for DropPacketCell&lt;P&gt;
where
    P: Packet + Send + Sync + 'static,
{
    type IngressType = DropPacketCellIngress&lt;P&gt;;
    type EgressType = DropPacketCellEgress&lt;P&gt;;
    type ControlInterfaceType = DropPacketCellControlInterface;

    fn sender(&amp;self) -&gt; Arc&lt;Self::IngressType&gt; {
        self.ingress.clone()
    }

    fn receiver(&amp;mut self) -&gt; &amp;mut Self::EgressType {
        &amp;mut self.egress
    }

    fn into_receiver(self) -&gt; Self::EgressType {
        self.egress
    }

    fn control_interface(&amp;self) -&gt; Arc&lt;Self::ControlInterfaceType&gt; {
        Arc::clone(&amp;self.control_interface)
    }
}

impl&lt;P&gt; DropPacketCell&lt;P&gt;
where
    P: Packet,
{
    pub fn new&lt;L: Into&lt;usize&gt;&gt;(loss_interval: L) -&gt; Result&lt;DropPacketCell&lt;P&gt;, Error&gt; {
        let loss_interval = loss_interval.into();
        let (rx, tx) = mpsc::unbounded_channel();
        let loss_interval = Arc::new(AtomicUsize::new(loss_interval));
        Ok(DropPacketCell {
            ingress: Arc::new(DropPacketCellIngress { ingress: rx }),
            egress: DropPacketCellEgress {
                egress: tx,
                loss_interval: loss_interval.clone(),
                inner_loss_interval: 0,
                state: AtomicI32::new(0),
                counter: 0,
            },
            control_interface: Arc::new(DropPacketCellControlInterface { loss_interval }),
        })
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="integrate-cell-to-rattan"><a class="header" href="#integrate-cell-to-rattan">Integrate Cell to Rattan</a></h2>
<p>In the guide above, we have created a new <code>Cell</code>. To integrate it into Rattan, you also have to implement the <code>CellFactory</code> trait, which serves as the builder function of the <code>Cell</code>.
The <code>CellFactory</code> trait is a type alias for a closure that takes a reference to a tokio runtime <code>Handle</code> and returns a <code>Cell</code> instance.
You should call the <code>build_cell</code> method of <code>RattanRadix</code> to build your cell.</p>
<p>It is recommended to implement a method for a struct to return the closure like the example below:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub type DropPacketCellBuildConfig = drop_packet::DropPacketCellConfig;

impl DropPacketCellBuildConfig {
    pub fn into_factory&lt;P: Packet&gt;(self) -&gt; impl CellFactory&lt;drop_packet::DropPacketCell&lt;P&gt;&gt; {
        move |handle| {
            let _guard = handle.enter();
            // Create the closure to build the cell
            drop_packet::DropPacketCell::new(self.loss_interval)
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<p>If you want to contribute back to the official Rattan repository or modify the source code, you can also add your build configuration type to the enum <code>CellBuildConfig</code>.
In this way, you can easily read its configuration from a TOML file through the <code>load_cells_config</code> method (which internally calls <code>build_cell</code> as well) of <code>RattanRadix</code>.
Remember to also derive the <code>Deserialize</code> and <code>Serialize</code> traits for your configuration struct in such cases.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum CellBuildConfig&lt;P: Packet&gt; {
    /* Other cells */
    DropPacket(DropPacketCellBuildConfig),
    Custom,
}
<span class="boring">}</span></code></pre></pre>
<p>Don't forget to modify <code>load_cells_config</code> in <code>RattanRadix</code> to add your cell configuration to the match statement.</p>
<p>Now, you can add your cell to a TOML file and use Rattan to try parsing it!
There is an example for you to refer to to write your TOML file:</p>
<pre><code class="language-toml"># Other Sections
# ...

# ----- Cells Section -----
# DropPacket Cell Example
[cells.my_drop]
type = "DropPacket"
loss_interval = 2

# Other Cells
# ...
# ----- Cells Section End -----
</code></pre>
<h2 id="test-your-new-cell"><a class="header" href="#test-your-new-cell">Test Your New Cell</a></h2>
<p>This section is optional when you are writing a new cell. Tests are only required when you wish to integrate your cell into Rattan's official repository and the corresponding CLI tool.</p>
<p>We require every cell to have unit tests and integration tests to check the correctness of the internal cell implementations and external interactions.</p>
<h3 id="unit-tests"><a class="header" href="#unit-tests">Unit Tests</a></h3>
<p>The goal of unit tests is to check whether the internal state of your cell transitions correctly and whether its functionality behaves as expected.
Typically, when writing unit tests, you create an instance of your cell, manually call its <code>enqueue</code> and <code>dequeue</code> methods, and observe the results to check its correctness.</p>
<p>To run the unit tests, you can first run <code>cargo nextest list --workspace</code> to view the list of unit tests, find the test(s) you want to run, and then run <code>cargo nextest run &lt;the name of your test&gt; --release --all-features --workspace</code> to execute your test(s).</p>
<p>Below are two examples of unit tests for <code>DropPacketCell</code> for reference:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(test)]
mod tests {
    use tracing::{info, span, Level};

    use crate::cells::StdPacket;

    use super::*;

    #[test_log::test]
    fn test_drop_packet_cell() -&gt; Result&lt;(), Error&gt; {
        let _span = span!(Level::INFO, "test_drop_packet_cell").entered();
        let rt = tokio::runtime::Builder::new_current_thread()
            .enable_all()
            .build()?;
        let _guard = rt.enter();

        info!("Creating cell with loss_interval 3");
        let cell = DropPacketCell::new(3_usize)?;
        let ingress = cell.sender();
        let mut egress = cell.into_receiver();
        egress.reset();
        egress.change_state(2);

        info!("Testing loss for drop packet cell of loss 3");
        let mut received_packets = vec![false; 100];

        for i in 0..100 {
            let mut test_packet = StdPacket::from_raw_buffer(&amp;[0; 256]);
            test_packet.set_flow_id(i);
            ingress.enqueue(test_packet)?;
            let received = rt.block_on(async { egress.dequeue().await });

            if let Some(content) = received {
                assert!(content.length() == 256);
                received_packets[content.get_flow_id() as usize] = true;
            }
        }
        info!("Tested loss sequence: {:?}", received_packets);
        for (i, item) in received_packets.iter().enumerate().take(100) {
            if (i + 1) % 3 == 0 {
                assert!(!item);
            } else {
                assert!(item);
            }
        }
        Ok(())
    }

    #[test_log::test]
    fn test_drop_packet_cell_config_update() -&gt; Result&lt;(), Error&gt; {
        let _span = span!(Level::INFO, "test_drop_packet_cell_config_update").entered();
        let rt = tokio::runtime::Builder::new_current_thread()
            .enable_all()
            .build()?;
        let _guard = rt.enter();

        info!("Creating cell with loss_interval 5");
        let cell = DropPacketCell::new(5_usize)?;
        let config_changer = cell.control_interface();
        let ingress = cell.sender();
        let mut egress = cell.into_receiver();
        egress.reset();
        egress.change_state(2);

        let mut received_packets = vec![false; 100];

        info!("Testing loss for drop packet cell of loss 5");

        for i in 0..48 {
            let mut test_packet = StdPacket::from_raw_buffer(&amp;[0; 256]);
            test_packet.set_flow_id(i);
            ingress.enqueue(test_packet)?;
            let received = rt.block_on(async { egress.dequeue().await });

            if let Some(content) = received {
                assert!(content.length() == 256);
                received_packets[content.get_flow_id() as usize] = true;
            }
        }
        for (i, item) in received_packets.iter().enumerate().take(48) {
            if (i + 1) % 5 == 0 {
                assert!(!item);
            } else {
                assert!(item);
            }
        }

        info!("Changing loss_interval to 3");
        config_changer.set_config(DropPacketCellConfig::new(3_usize))?;

        for i in 48..100 {
            let mut test_packet = StdPacket::from_raw_buffer(&amp;[0; 256]);
            test_packet.set_flow_id(i);
            ingress.enqueue(test_packet)?;
            let received = rt.block_on(async { egress.dequeue().await });

            if let Some(content) = received {
                assert!(content.length() == 256);
                received_packets[content.get_flow_id() as usize] = true;
            }
        }
        info!("Tested loss sequence: {:?}", received_packets);
        for i in 0..=51 {
            if i % 3 == 0 {
                assert!(!received_packets[i + 48]);
            } else {
                assert!(received_packets[i + 48]);
            }
        }
        Ok(())
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="integration-tests"><a class="header" href="#integration-tests">Integration Tests</a></h3>
<p>The purpose of integration tests is to check whether your cell interacts correctly with Rattan's runtime.
When writing integration tests, you need to first create your cell in the rattan runtime, and then execute commands such as <code>ping</code> between network namespaces to observe whether your cell behaves as expected.</p>
<p>To run the integration tests, you can first run <code>cargo nextest list --workspace</code> to view the list of integration tests, find the test you want to run, and then run <code>cargo nextest run &lt;the name of your test&gt; --release --all-features --workspace</code> to execute your test.</p>
<p>Here is an example of an integration test for reference:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[instrument]
#[test_log::test]
fn test_drop_packet() {
    let mut config = RattanConfig::&lt;StdPacket&gt; {
        env: StdNetEnvConfig {
            mode: StdNetEnvMode::Isolated,
            client_cores: vec![1],
            server_cores: vec![3],
            ..Default::default()
        },
        ..Default::default()
    };
    config.cells.insert(
        "up_drop".to_string(),
        CellBuildConfig::DropPacket(DropPacketCellConfig::new(0_usize)),
    );
    config.cells.insert(
        "down_drop".to_string(),
        CellBuildConfig::DropPacket(DropPacketCellConfig::new(0_usize)),
    );
    config.links = HashMap::from([
        ("left".to_string(), "up_drop".to_string()),
        ("up_drop".to_string(), "right".to_string()),
        ("right".to_string(), "down_drop".to_string()),
        ("down_drop".to_string(), "left".to_string()),
    ]);
    let mut radix = RattanRadix::&lt;AfPacketDriver&gt;::new(config).unwrap();
    radix.spawn_rattan().unwrap();
    radix.start_rattan().unwrap();

    // Wait for AfPacketDriver to be ready
    std::thread::sleep(std::time::Duration::from_millis(100));

    // Before set the LossCell, the average loss rate should be 0%
    {
        let _span = span!(Level::INFO, "ping_no_loss").entered();
        info!("try to ping with no loss");
        let right_ip = radix.right_ip(1).to_string();
        let left_handle = radix
            .left_spawn(None, move || {
                let handle = std::process::Command::new("ping")
                    .args([&amp;right_ip, "-c", "20", "-i", "0.3"])
                    .stdout(std::process::Stdio::piped())
                    .spawn()
                    .unwrap();
                Ok(handle.wait_with_output())
            })
            .unwrap();
        let output = left_handle.join().unwrap().unwrap().unwrap();
        let stdout = String::from_utf8(output.stdout).unwrap();

        let re = Regex::new(r"(\d+)% packet loss").unwrap();
        let loss_percentage = re
            .captures(&amp;stdout)
            .map(|cap| cap[1].parse::&lt;u64&gt;())
            .unwrap()
            .unwrap();
        info!("loss_percentage: {}", loss_percentage);
        assert!(loss_percentage == 0);
    }

    // After set the loss_interval of DropPacketCell to 2, the average loss rate should be 50%
    {
        let _span = span!(Level::INFO, "ping_with_loss").entered();
        info!("try to ping with loss interval set to 2");
        radix
            .op_block_exec(RattanOp::ConfigCell(
                "up_drop".to_string(),
                serde_json::to_value(DropPacketCellConfig::new(2_usize)).unwrap(),
            ))
            .unwrap();

        let right_ip = radix.right_ip(1).to_string();
        let left_handle = radix
            .left_spawn(None, move || {
                let handle = std::process::Command::new("ping")
                    .args([&amp;right_ip, "-c", "50", "-i", "0.3"])
                    .stdout(std::process::Stdio::piped())
                    .spawn()
                    .unwrap();
                Ok(handle.wait_with_output())
            })
            .unwrap();
        let output = left_handle.join().unwrap().unwrap().unwrap();
        let stdout = String::from_utf8(output.stdout).unwrap();

        let re = Regex::new(r"(\d+)% packet loss").unwrap();
        let loss_percentage = re
            .captures(&amp;stdout)
            .map(|cap| cap[1].parse::&lt;u64&gt;())
            .unwrap()
            .unwrap();
        info!("loss_percentage: {}", loss_percentage);
        assert!((loss_percentage == 50));
    }
}
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="write-your-tailored-tool-todo"><a class="header" href="#write-your-tailored-tool-todo">Write Your Tailored Tool (TODO)</a></h1>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="run-server-inside-rattan-to-serve-public-traffic"><a class="header" href="#run-server-inside-rattan-to-serve-public-traffic">Run Server inside Rattan to Serve Public Traffic</a></h1>
<p>You can find the complete code to run this example in the <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server">examples/public-server</a> folder.</p>
<h2 id="configure-the-network-conditions-of-the-emulated-internet-path"><a class="header" href="#configure-the-network-conditions-of-the-emulated-internet-path">Configure the Network Conditions of the Emulated Internet Path</a></h2>
<p>So first, we need to create a TOML file to describe the Internet path we want to emulate.
In our current example, as we need to run a public server, we will use the <code>Compatible</code> mode of Rattan and set a typical Internet path configuration: one uplink and one downlink, each with 20 ms delay, and no packet loss. The difference is in bandwidth: the uplink is 100 Mbps with infinite queue, and the downlink is a token bucket with rate limited to 2Mbps.</p>
<p>For the full configuration file, we refer the readers to <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/rattan.toml">examples/public-server/rattan.toml</a></p>
<h2 id="write-scripts-to-exchange-information-for-ip-forwarding"><a class="header" href="#write-scripts-to-exchange-information-for-ip-forwarding">Write Scripts to Exchange Information for IP Forwarding</a></h2>
<p>To present more clearly how to run a server inside Rattan and allow it to serve public traffic,
we have placed different functionalities in three separate scripts: <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/main.sh">main.sh</a>, <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/inner.sh">inner.sh</a>, and <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/run.sh">run.sh</a>.
Users only need to write the command to start the server in <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/run.sh">run.sh</a> and then directly execute the <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/main.sh">main.sh</a> script.</p>
<p>To specify the outer port on the host and the inner port of the server inside Rattan, we can run the script with arguments:</p>
<pre><code class="language-bash">bash main.sh --inner-port 5201 --outer-port 35201
</code></pre>
<p>For the rest of this section, we will explain how these scripts work and how they set up the IP forwarding rules on the host machine.</p>
<p>As an example, we serve <code>iperf3</code> server inside Rattan, which is in the <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/run.sh">run.sh</a> script.
You can also modify this script to run your own server.</p>
<p>What inside the script is very simple: <code>iperf3 -s -1</code></p>
<p>Now we have to setup the IP forwarding rules to forward traffic from a public port on the host machine to the inner port inside Rattan's network namespace.</p>
<p>We have created a pair of scripts, <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/main.sh">main.sh</a> and <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/inner.sh">inner.sh</a>,
to get the internal IP of Rattan so to set forwarding rules on the host machine.</p>
<p>We use temporary files named with random UUIDs as a way to pass messages, created by the <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/main.sh">main.sh</a>, which polls the content to obtain the IP reported from <a href="https://github.com/stack-rs/rattan/tree/main/examples/public-server/inner.sh">inner.sh</a>. Then we use the following command to create forwarding rules:</p>
<pre><code class="language-bash">sudo iptables -t nat -A PREROUTING -p tcp --dport $OUTER_PORT -j DNAT --to-destination "$INNER_IP:$INNER_PORT"
</code></pre>
<p>This will forward the traffic from 0.0.0.0:$OUTER_PORT to $INNER_IP:$INNER_PORT</p>
<p>Our scripts will clean the forwarding rules on exit and you can also delete the rule manually with the following command:</p>
<pre><code class="language-bash">sudo iptables -t nat -D PREROUTING -p tcp --dport $OUTER_PORT -j DNAT --to-destination "$INNER_IP:$INNER_PORT"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="packet-io"><a class="header" href="#packet-io">Packet I/O</a></h1>
<p>Currently, we support two packet I/O mechanisms: <code>AF_PACKET</code> and <code>AF_XDP</code>. The former is a socket-based mechanism, while the latter is a driver-based mechanism. The <code>AF_PACKET</code> version is more portable, while the <code>AF_XDP</code> version is more performant.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<p>By default, the <code>AF_PACKET</code> version is used. To use the <code>AF_XDP</code> version, you need to enable the <code>camellia</code> feature.</p>
<pre><code class="language-bash">cargo run --example channel --release # AF_PACKET version
cargo run --example channel-xdp --release --features="camellia" # AF_XDP version
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="flamegraph"><a class="header" href="#flamegraph">Flamegraph</a></h1>
<p>To generate a flamegraph, you can use the <code>flamegraph</code> tool. First, install it:</p>
<pre><code class="language-bash">cargo install flamegraph
</code></pre>
<p>Then, run the following command:</p>
<pre><code class="language-bash">cargo flamegraph --root --example channel
</code></pre>
<p>This will generate a flamegraph, which you can open with a browser to inspect hot spot.</p>
<div style="break-before: page; page-break-before: always;"></div><style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="packet-log"><a class="header" href="#packet-log">Packet Log</a></h1>
<p>The Rattan packet log contains the following binary files:</p>
<ul>
<li>A <code>.flow</code> file, which contains a basic description of all (recognized) flows processed by Rattan.</li>
<li>A <code>.rtl</code> file, which contains a compressed record of the packets in those flows.</li>
<li>Optionally, a <code>.raw</code> file, which contains the protocol headers of those packets.</li>
</ul>
<p>It is designed to store what happened during the experiment with low overhead, enabling post-analysis and debugging.</p>
<p><strong>Notice</strong>:
Rattan currently records TCP flows on IPv4 only. Any other packets that are not recognized as a TCP flow on IPv4 are ignored
when recording a Rattan packet log, while they are normally processed and forwarded by
Rattan (e.g., UDP flows).</p>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<h3 id="record-a-rattan-packet-log"><a class="header" href="#record-a-rattan-packet-log">Record a Rattan packet Log</a></h3>
<p>Two options are involved: <code>--packet-log</code> and <code>--packet-log-mode</code> . Example usages are:</p>
<pre><code class="language-bash">rattan link --packet-log packet.rtl --packet-log-mode compact-tcp
rattan run --config config.toml --packet-log packet.rtl --packet-log-mode raw-ip
</code></pre>
<p>The possible values for <code>--packet-log-mode</code> are:</p>
<ul>
<li><code>compact-tcp</code> (as default, if not specified). In this mode, some fields from TCP and IP headers are recorded.</li>
<li><code>raw-ip</code>. In this mode, the raw L3 and L4 headers are recorded.</li>
<li><code>raw-tcp</code>. In this mode, the raw L4 headers are recorded.</li>
</ul>
<p>This will create a file named <code>packet.rtl</code> in the current directory, which will contain the compressed packet log.
The flow description file will be named <code>packet.flows</code>. Also, if any raw headers are recorded, a <code>packet.raw</code> will be created.</p>
<h3 id="convert-a-rattan-packet-log"><a class="header" href="#convert-a-rattan-packet-log">Convert a Rattan packet log</a></h3>
<h4 id="rust-subcommand"><a class="header" href="#rust-subcommand">Rust subcommand</a></h4>
<p>To convert a Rattan packet log to a <code>.pcapng</code> file, which can be viewed with Wireshark or other tools, we provide
a subcommand <code>convert</code>.</p>
<p>Example usage:</p>
<pre><code class="language-bash">rattan convert ./packet.rtl [path/to/output]
</code></pre>
<p>This expects the following files exist, as input:</p>
<ul>
<li><code>./packet.rtl</code></li>
<li><code>./packet.flows</code></li>
<li><code>./packet.raw</code> (optional, only if the packet log was recorded in <code>raw-tcp</code> or <code>raw-ip</code> mode).</li>
</ul>
<p>And it will generate the following files, as output, if the address of the two ends of the emulated link
of Rattan was <code>10.1.1.1</code> and <code>10.2.1.1</code>":</p>
<ul>
<li><code>path/to/output_10_1_1_1.pcapng</code></li>
<li><code>path/to/output_10_2_1_1.pcapng</code></li>
</ul>
<p>If the second argument was not provided (the output prefix), the default value for it is the first argument (the path
to the <code>.rtl</code> file).</p>
<p>Note that, in <code>compact-tcp</code> mode, some fields are artificially constructed in the pcapng file, as the compressed
packet log only stores partial information. Artificial fields include:</p>
<ul>
<li><code>Window</code>: The TCP window size is set to <code>65535</code> for all packets.</li>
<li><code>Checksum</code>: The TCP checksum is set to <code>0</code> for all packets.</li>
<li><code>Urgent Pointer</code>: The TCP urgent pointer is set to <code>0</code> for all packets.</li>
<li><code>Options</code>: The TCP header length is real, but option content is set to <code>0</code> for all packets.</li>
</ul>
<p>Besides, in <code>raw-tcp</code> mode, some fields are artificially constructed in the pcapng file, since per-packet
info in IP headers are not recorded at all. Artificial fields include:</p>
<ul>
<li><code>Identification</code>: Set to <code>0</code>.</li>
<li><code>Flags</code> : Set to <code>Don't Fragment</code>.</li>
<li><code>Checksum</code> : Set to <code>0</code>, or disabled.</li>
</ul>
<h4 id="python-script"><a class="header" href="#python-script">Python script</a></h4>
<p>We provide a python script (<a href="https://github.com/stack-rs/rattan/blob/main/scripts/log_converter.py">scripts/log_converter.py</a>), that provides basically the same function as the above-mentioned Rust subcommand does.
Notice that the Python script can be slower than the Rust subcommand by one to
two orders of magnitude when processing large log files.</p>
<p>Example usage:</p>
<pre><code class="language-bash">python scripts/log_converter.py ./packet.rtl path/to/output
</code></pre>
<p>or, use the script as a <a href="https://docs.astral.sh/uv/guides/scripts/#using-a-shebang-to-create-an-executable-file">uv script</a> to automatically handle dependencies.</p>
<pre><code class="language-bash">uv run --script scripts/log_converter.py ./packet.rtl path/to/output
</code></pre>
<p>The paths to input and output files are the same as those for <code>rattan convert</code>, and the behaviour of the python script is basically the same as <code>rattan convert</code>.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<h3 id="raw-file"><a class="header" href="#raw-file">Raw file</a></h3>
<p>A <code>.raw</code> file is an unstructured binary file. Currently, the headers recorded
in <code>raw-tcp</code> and <code>raw-ip</code> modes are directly written into the <code>.raw</code> file continuously,
without any padding, header or index.
The file is considered a byte buffer, where a slice (starting from <code>offset</code> bytes from
the head of the file and ending at <code>offset</code> + <code>length</code>)
can be indexed by the pair (<code>offset</code>, <code>length</code>).</p>
<h3 id="log-entry-file"><a class="header" href="#log-entry-file">Log entry file</a></h3>
<p>Now we have 2 kinds of log entry files:</p>
<ul>
<li><code>.flows</code> files, which contains the metadata for flows. They consist of <code>Flow Entries</code>.</li>
<li><code>.rtl</code> files, which contains per-packet log for packets in those flows.
<ul>
<li>For non-raw modes, they consist of non-raw <code>General Packet Entries</code>.</li>
<li>For raw modes, they consist of chunks. Each chunk starts with a <code>Chunk Prologue</code>, which is followed by raw <code>General Packet Entries</code>.</li>
</ul>
</li>
</ul>
<p>Above mentioned log entry types are described as follows.</p>
<p>Every log entry file consists of <code>Log Entries</code>.
Those log entries are stored in system endianness (little-endian in most cases and in our tests).
The specification for a log entry is as follows:</p>
<pre><code class="language-text">0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       LH.length       | LH.ty.|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               +
|                                                               |
+                                                               +
|                            payload                            |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<pre><code class="language-bash">protocol "LH.length:12,LH.ty.:4,payload:112"
</code></pre>
<p>Generated with <a href="https://github.com/luismartingarcia/protocol">protocol</a>, where
<code>LH</code> is short for log entry header.</p>
<p><code>LH.length</code> denotes the whole length of the log entry file, including the header (2 bytes) and its payload, in bytes.</p>
<p>Currently, there are multiple types of <code>LH.ty.</code> that indicate how a log entry's payload is organized. They are:</p>
<ul>
<li><code>LH.ty.</code> = 0, for a General Packet Entry as payload.</li>
<li><code>LH.ty.</code> = 1, reserved for future use.</li>
<li><code>LH.ty.</code> = 2, for a Flow Entry as payload,</li>
<li><code>LH.ty.</code> = 15, for a Chunk Prologue as payload,</li>
</ul>
<h4 id="chunk-prologue-entry"><a class="header" href="#chunk-prologue-entry">Chunk Prologue Entry</a></h4>
<p>A chunk prologue entry is a log entry with <code>LH.ty.</code> = 15, which is used in raw-mode packet logs.</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       LH.length       | LH.ty.|       CPH.length      |CPH.ty.|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        CPH.log_version                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        CPH.data_length                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        CPH.chunk_length                       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                           CP (custom)                         +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<pre><code class="language-bash">protocol "LH.length:12,LH.ty.:4,CPH.length:12,CPH.ty.:4,CPH.log_version:32,CPH.data_length:32,CPH.chunk_length:32,CP (custom):128"
</code></pre>
<p>Where <code>CPH</code> is short for Chunk Prologue Header, and <code>CP</code> is short for Chunk Prologue.
The meaning of each field is as follows:</p>
<ul>
<li><code>CPH.length</code> denotes the length of the chunk prologue entry itself.</li>
<li><code>CPH.ty.</code> is always 0 now.</li>
<li><code>CPH.log_version</code> is a magic number, which is 0x20260101 in this specification.</li>
<li><code>CPH.data_length</code> is the sum of the length of this Chunk Prologue Entry and all subsequent content (which, for now, consists solely of raw General Packet Entries).</li>
<li><code>CPH.chunk_length</code> is the logical length of the current chunk. It indicates that the next Chunk Prologue is expected to be found, or the End-of-File (EOF) is expected to be reached, exactly <code>CPH.chunk_length</code> bytes from the offset of this log entry.</li>
</ul>
<p>And when <code>CPH.ty.</code> is 0, the body part of the Chunk Prologue is:</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                           CP.offset                           +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                            Reserved                           +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<pre><code class="language-bash">protocol "CP.offset:64,Reserved:64"
</code></pre>
<p>Where <code>CP</code> is short for Chunk Prologue.
<code>CP.offset</code> is a 64-bit integer, whose value is referenced by the raw General Packet entries in the chunk that this
Chunk Prologue introduces.</p>
<h4 id="general-packet-entry"><a class="header" href="#general-packet-entry">General Packet Entry</a></h4>
<p>A General Packet Entry is a log entry with <code>LH.ty.</code> = 0, which records a packet.</p>
<p>There are two modes of General Packet Entries:</p>
<ul>
<li>non-raw (<code>GPH.ty.</code> = 0), and</li>
<li>raw (<code>GPH.ty.</code> = 1, 2).</li>
</ul>
<p><strong>non-raw General Packet Entry</strong>:
The specification for a non-raw General Packet Entry:</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       LH.length       | LH.ty.|   GPH.length  |GPH.ac.|GPH.ty.|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          GP.timestamp                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           GP.length           |       PRH.length      |PRH.ty.|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          PRT (custom)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<ul>
<li><code>GPH</code> is short for general packet entry header.</li>
<li><code>GP</code> is short for general packet entry (the body part).</li>
<li><code>PRH</code> is short for protocol entry header.</li>
<li><code>PRT</code> is short for protocol entry (the body part).</li>
<li><code>ty.</code> is short for type.</li>
<li><code>ac.</code> is short for action.</li>
</ul>
<pre><code class="language-bash">protocol "LH.length:12,LH.ty.:4,GPH.length:8,GPH.ac.:4,GPH.ty.:4,GP.timestamp:32,GP.length:16,PRH.length:12,PRH.ty.:4,PRT (custom):32"
</code></pre>
<p>The meaning of each field is as follows:</p>
<ul>
<li><code>LH.length</code>: Length of the whole log entry in bytes. For TCP log entries, it is 32 bytes.</li>
<li><code>LH.ty.</code>: Type of the log entry, currently only <code>0</code> is supported (indicating a general packet entry).</li>
<li><code>GPH.length</code>: Length of the general packet entry in bytes, including the header and body (<code>GPH</code> + <code>GP</code>). It is 8 bytes in most cases.</li>
<li><code>GPH.ac.</code>: Action of the general packet entry. It can be one of the following values:
<ul>
<li><code>0</code>: Send (packet leaves Rattan)</li>
<li><code>1</code>: Receive (packet enters Rattan)</li>
<li><code>2</code>: Drop (packet is dropped by Rattan)</li>
<li><code>3</code>: Passthrough (packet passes through Rattan without any effect applied)</li>
</ul>
</li>
<li><code>GPH.ty.</code>: Type of the general packet entry, <code>0</code> for non-raw GPH.</li>
<li><code>GP.timestamp</code>: Timestamp of the packet entry in microseconds since <code>base_ts</code> (in flow description file).</li>
<li><code>GP.length</code>: Length of the whole packet in bytes.</li>
<li><code>PRH.length</code>: Length of the protocol entry in bytes, including the header and body (<code>PRH</code> + <code>PRT</code>). For TCP log entries, it is 22 bytes.</li>
<li><code>PRH.ty.</code>: Type of the protocol entry, currently only <code>0</code> is supported (indicating a TCP log entry).</li>
<li><code>PRT</code>: The body part of the protocol entry, which contains the protocol-specific information.</li>
</ul>
<p>We currently provide TCP log spec (a variant of the protocol entry body part, i.e. <code>PRT (custom)</code>):</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          tcp.flow_id                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            tcp.seq                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            tcp.ack                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|             ip.id             |            ip.frag            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          ip.checksum          |   tcp.flags   |  tcp.dataofs  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

</code></pre>
<pre><code class="language-bash">protocol "tcp.flow_id:32,tcp.seq:32,tcp.ack:32,ip.id:16,ip.frag:16,ip.checksum:16,tcp.flags:8,tcp.dataofs:8"
</code></pre>
<p>Note that the <code>ip.frag</code> includes the fragment offset and the flags. Other fields are self-explanatory.</p>
<p><strong>raw General Packet Entry</strong>:
The specification for a raw General Packet Entry:</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       LH.length       | LH.ty.|   GPH.length  |GPH.ac.|GPH.ty.|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                          GP.timestamp                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           GP.length           |         RGP.flow_index        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|              RGP.relative_offset              |    RGP.len.   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<pre><code class="language-bash">protocol "LH.length:12,LH.ty.:4,GPH.length:8,GPH.ac.:4,GPH.ty.:4,GP.timestamp:32,GP.length:16,RGP.flow_index:16,RGP.relative_offset:24,RGP.len.:8"
</code></pre>
<p>The <code>GP</code> and <code>GPH</code> fields have the same meaning as those in non-raw General Packet Entries.
And <code>RGP</code> is short for raw General Packet.</p>
<p>For raw General Packet Entries, <code>GPH.ty.</code> could be one of:</p>
<ul>
<li><code>GPH.ty.</code> = 1, for raw packet logs with raw L3 and L4 headers (<code>raw-ip</code>).</li>
<li><code>GPH.ty.</code> = 2, for raw packet logs with raw L4 headers (<code>raw-tcp</code>).</li>
</ul>
<p>And those are descriptions for other fields that will be only used in raw General Packet Entries:</p>
<p>If <code>RGP.flow_index</code> is 0, it is a default value for packets that can not be
related to a recorded flow for any reason. Otherwise, it means the index of flow in the <code>.flow</code> file (counting from 1), that this packet belongs to. It is used, rather
than directly the 32-bit flow id, for a more compact and cache line-friendly representation.</p>
<p>Instead of recording the variable-length raw headers of the packet directly in the raw mode General Packet Entry, we record them in an indirect way:</p>
<p>The raw headers are continuously written into the <code>.raw</code> file, and the length of the headers of a certain packet can be located in the <code>.raw</code> file by the byte range <code>[start, start + length)</code>. Both the <code>start</code> and <code>length</code> are recorded in the <code>.rtl</code> file in the following way:</p>
<p>The <code>start</code> is recorded as <code>CP.offset</code> + <code>RGP.relative_offset</code>. Here, <code>CP.offset</code> is the value of that field in the Chunk Prologue of the current chunk,
and <code>RGP.relative_offset</code> is the value of that field in the current raw General Packet Entry.
Notably, <code>CP.offset</code> is a 64-bit unsigned integer and <code>RGP.relative_offset</code> is a 24-bit unsigned integer. This design prevents the overflow of the resulting <code>start</code> offset while maintaining a compact representation for the raw General Packet Entry.</p>
<p>The <code>length</code> is recorded as <code>RGP.len</code> in the current raw General Packet Entry. The <code>length</code> is a 8-bit unsigned integer, which means that the maximum allowed length of the raw headers recorded by a raw General Packet Entry is 255 bytes.</p>
<h4 id="flow-entry"><a class="header" href="#flow-entry">Flow Entry</a></h4>
<p>A flow entry is a log entry with <code>LH.ty.</code> = 2, which records basic descriptive info for a flow.</p>
<p>A "flow" is unidirectional in Rattan Packet Log.
For example, a single connection between a TCP client and TCP server is considered as 2 flows.</p>
<p>Currently there are only one type of flows supported, the TCP/IPv4 flow, and the Flow entries for those flows, stored continuously in the <code>.flow</code> file, have a specification as follows:</p>
<pre><code class="language-text"> 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|       LH.length       | LH.ty.|       FLH.length      |FLH.ty.|
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             FLE.id                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             src.ip                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             dst.ip                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            src.port           |            dst.port           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                       FLE.base_timestamp                      +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            Reserved                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+                      FLE.tcp_syn_options                      +
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+                                                               +
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre>
<pre><code class="language-bash">protocol "LH.length:12,LH.ty.:4,FLH.length:12,FLH.ty.:4,FLE.id:32,src.ip:32,dst.ip:32,src.port:16,dst.port:16,FLE.base_timestamp:64,Reserved:32,FLE.tcp_syn_options:320"
</code></pre>
<p>Where <code>FLH</code> is short for Flow Entry Header, and <code>FLE</code> is short for Flow Entry.
The meaning of each field is as follows:</p>
<ul>
<li><code>FLH.length</code> is the length for the whole flow entry.</li>
<li><code>FLH.ty.</code> must be 0, denoting a TCP/IPv4 flow.</li>
<li><code>FLE.id</code>: The identifier of the flow. The high 16 bits are the interface ID where the packet enters Rattan, and the low 16 bits are the incremental flow counter.</li>
<li><code>FLE.base_timestamp</code>: The base timestamp in nanoseconds (this unit is different from the <code>GP.timestamp</code> field) for this flow.</li>
<li><code>src.ip</code>, <code>dst.ip</code>, <code>src.port</code>, <code>dst.port</code>: The source IPv4 address, destination IPv4 address, source TCP port number, destination TCP port number.</li>
<li><code>FLE.tcp_syn_options</code>: As flows are unidirectional here, only one valid SYN (TCP client side) or SYN_ACK (TCP server side) packet would exist in a TCP connection. The TCP options fields in such packets are recorded in raw here. This field has a fixed length of 40 bytes, and zero-padding at the end if the tcp options are less than 40 bytes. 40 bytes are the upper limit in TCP protocol: a TCP header can be at most 15
* 4 = 60 bytes in length, and the first 20 bytes are used for fixed fields in the TCP header.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
